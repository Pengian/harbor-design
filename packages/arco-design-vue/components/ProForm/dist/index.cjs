"use strict";var k=Object.defineProperty;var W=(u,e,t)=>e in u?k(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var a=(u,e,t)=>(W(u,typeof e!="symbol"?e+"":e,t),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("vue");class R{constructor(e){a(this,"runtimeCore");this.formCustomization=e}cleanFallbackFields(e){return e!==null&&typeof e=="object"&&(delete e.__yiwwhl_async_field_fallback,Object.values(e).forEach(t=>{this.cleanFallbackFields(t)})),e}setup(e){return this.runtimeCore=e,this.formCustomization}submit(){return new Promise((e,t)=>{this.runtimeCore.formRef.value.validate(i=>i?t(i):e(this.cleanFallbackFields(l.toRaw(this.runtimeCore.processors.processedModel.value))))})}}class m{static typeChecker(e){return{}.toString.call(e)}static isArray(e){return this.typeChecker(e)==="[object Array]"}static isFunction(e){return this.typeChecker(e).includes("Function")}static isAsyncFunction(e){let t=!1;return this.typeChecker(e)==="[object AsyncFunction]"&&(t=!0),t}static isUndefined(e){return e===void 0}static isArrayEmpty(e){return(e==null?void 0:e.length)<1}static isObjectEmpty(e){return this.isArrayEmpty(Object.keys(e))}static isListSchema(e){return e.type==="list"}static isGroupSchema(e){return e.type==="group"}static isItemSchema(e){return this.isUndefined(e.type)||e.type==="item"}}function V(u){const e=new WeakMap;function t(i){if(i===null||typeof i!="object")return i;if(i instanceof Date)return new Date(i);if(i instanceof RegExp)return new RegExp(i);if(i instanceof Map){const o=new Map;for(let[s,c]of i)o.set(t(s),t(c));return o}if(i instanceof Set){const o=new Set;for(let s of i)o.add(t(s));return o}if(e.has(i))return e.get(i);if(Array.isArray(i)){const o=[];e.set(i,o);for(let s=0;s<i.length;s++)o[s]=t(i[s]);return o}const f=Object.create(Object.getPrototypeOf(i));e.set(i,f);for(let o in i)i.hasOwnProperty(o)&&(f[o]=t(i[o]));return f}return t(u)}class C{constructor(e,t){a(this,"rawSchemas",[]);a(this,"rawModel",{});a(this,"schemaPreset",A.schemaPreset);a(this,"componentPropsPreset",A.componentPropsPreset);a(this,"uniqueEffectMap",{});a(this,"schemaEffect",new S);a(this,"modelEffect",new S);a(this,"stopWatchEffect",new S);this.processedSchemas=e,this.processedModel=t,l.watch(()=>this.processedModel.value,()=>{this.schemaEffect.triggerEffects(),this.modelEffect.triggerEffects()},{deep:!0})}schemaAnalyzer(e,t=this.processedSchemas.value,i=this.rawSchemas,f,o){for(let s=0;s<e.length;s++){let c=e[s];this.schemaProcessor(c,s,(v,E,h)=>{h?i[s][h]=v[h]:(t[s]=v,this.modelProcessor(v,f&&this.processedModel.value[f][0]),(!i[s]||E)&&(i[s]=V(v)),this.schemaEffect.triggerEffects(),this.modelEffect.triggerEffects())},o,f)}}schemaProcessor(e,t,i,f,o){const s={},c=this;function v(E=!1){var h,P;if(s.componentProps){const d={};c.propsProcessor(s.componentProps,c.componentPropsPreset,d,y=>{s.componentProps=d,i({...s},y,"componentProps")},t,f);return}if(s.children){c.processedSchemas.value[t]=s,c.rawSchemas[t]=s,i({...s},E),c.schemaAnalyzer(s.children,(h=c.processedSchemas.value[t])==null?void 0:h.children,(P=c.rawSchemas[t])==null?void 0:P.children,s.field,t);return}i({...s},E),c.rawModel=V(c.processedModel.value)}this.propsProcessor(e,this.schemaPreset,s,v,t,f,o)}replaceFunctionsWithUndefined(e){if(typeof e!="object"||e===null)return e;for(let t in e)if(e.hasOwnProperty(t)){let i=e[t];typeof i=="function"||typeof i=="object"&&this.replaceFunctionsWithUndefined(i)}return e}runtimeMeta(){return{model:this.replaceFunctionsWithUndefined(l.toRaw(V(this.processedModel.value)))}}propsProcessor(e,t,i,f,o,s,c){const v=Object.keys(e),E=Array.from({length:v.length}).fill(!1);function h(){return E.every(P=>P)}for(let P=0;P<v.length;P++){const d=v[P],y=e[d];if(m.isFunction(y)){const w=y(this.runtimeMeta());d!=="defaultValue"?this.schemaEffect.trackEffect(()=>{let n=y(this.runtimeMeta());n instanceof Promise?n.then(r=>{s===void 0?m.isFunction(r)||(typeof r=="string"&&r.includes("undefined")&&(r=r.replace(/undefined/g,"")),this.processedSchemas.value[o][d]=r):m.isFunction(r)||(typeof r=="string"&&r.includes("undefined")&&(r=r.replace(/undefined/g,"")),this.processedSchemas.value[s].children[o][d]=r)}):s===void 0?m.isFunction(n)||(typeof n=="string"&&n.includes("undefined")&&(n=n.replace(/undefined/g,"")),this.processedSchemas.value[o][d]=n):m.isFunction(n)||(typeof n=="string"&&n.includes("undefined")&&(n=n.replace(/undefined/g,"")),this.processedSchemas.value[s].children[o][d]=n)}):this.modelEffect.trackEffect(()=>{let n=y(this.runtimeMeta());this.stopWatchEffect.trackEffect(l.watchEffect(()=>{if(n=y(this.runtimeMeta()),n instanceof Promise)n.then(r=>{if(typeof r=="string"&&!r.includes("undefined")?this.stopWatchEffect.triggerEffects():r=r.replace(/undefined/g,""),o===void 0||c===void 0){if(m.isFunction(e.field)){const p=e.field(this.runtimeMeta());p instanceof Promise?p.then(g=>{this.processedModel.value[g]=r}):this.processedModel.value[p]=r;return}this.processedModel.value[e.field]=r}else{if(m.isFunction(e.field)){const p=e.field(this.runtimeMeta());p instanceof Promise?p.then(g=>{this.processedModel.value[c][o][g]=r}):this.processedModel.value[c][o]&&(this.processedModel.value[c][o][p]=r);return}this.processedModel.value[c]&&this.processedModel.value[c].forEach(p=>{p[e.field]=r})}this.rawModel=V(this.processedModel.value),this.modelEffect.clearEffects()});else{if(typeof n=="string"&&!n.includes("undefined")?this.stopWatchEffect.triggerEffects():n=n.replace(/undefined/g,""),m.isFunction(e.field)){const r=e.field(this.runtimeMeta());r instanceof Promise?r.then(p=>{this.processedModel.value[p]=n}):this.processedModel.value[r]=n;return}if(this.processedModel.value[e.field]=n,o===void 0||c===void 0){if(m.isFunction(e.field)){const r=e.field(this.runtimeMeta());r instanceof Promise?r.then(p=>{this.processedModel.value[p]=n}):this.processedModel.value[r]=n;return}this.processedModel.value[e.field]=n}else for(let r=0;r<this.processedModel.value[c].length;r++){const p=this.processedModel.value[c][r];if(!m.isFunction(e.field))p[e.field]=n;else{const g=e.field(this.runtimeMeta());g instanceof Promise?g.then(N=>{p[N]=n}):p[g]=n;return}}this.rawModel=V(this.processedModel.value),this.modelEffect.clearEffects()}}))}),w instanceof Promise?(E[P]=!0,i[d]=t[d].defaultValueWhenAsync,h()&&f(),w.then(n=>{E[P]=!0,i[d]=n,h()&&f(!0)})):(E[P]=!0,i[d]=w,h()&&f())}else E[P]=!0,l.isRef(y)?l.watch(()=>y.value,w=>{i[d]=w,h()&&f()},{immediate:!0,deep:!0}):l.isReactive(y)?l.watch(()=>y,w=>{i[d]=w,h()&&f()},{immediate:!0,deep:!0}):(i[d]=y,h()&&f())}}modelProcessor(e,t=this.processedModel.value){if(m.isListSchema(e)){if(m.isFunction(e.field))return;t[e.field]||(t[e.field]=[{}]),e.children.forEach(i=>{this.modelProcessor(i,t[e.field][0])});return}if(m.isGroupSchema(e)){e.children.forEach(i=>{this.modelProcessor(i,t)});return}if(m.isItemSchema(e)){if(m.isFunction(e.field)||m.isUndefined(e.field)||!Number.isNaN(Number(e.field))||m.isFunction(e.defaultValue))return;t[e.field]=e.defaultValue}}}function b(u){return typeof u=="function"||Object.prototype.toString.call(u)==="[object Object]"&&!l.isVNode(u)}class D{constructor(e){a(this,"schemas",l.ref([]));a(this,"model",l.ref({}));a(this,"processorBySchemaType",{item:this.runtimeItemProcessor.bind(this),group:this.runtimeGroupProcessor.bind(this),list:this.runtimeListProcessor.bind(this)});a(this,"formRef",l.ref(null));this.setup=e,this.processors=new C(this.schemas,this.model),this.analyze(this.setup(this))}analyze(e){this.processors.schemaAnalyzer(e.schemas)}runtimeItemProcessor(e,t,i=this.model.value,f){var y;const o=f?`${f.field}.${t}.${e.field}`:e.field,s=l.toRaw(e.component),c=s.name,v=e.componentProps??{},E=A.placeholderPresetByComponentName;let h=e.placeholder;h||(h=`${E[c]??"请输入"}${e.label}`),e.required&&(e.rules||(e.rules=[]),(y=e.rules)==null||y.push({required:!0,message:`${e.label}是必填项`}));let d=e.show;return d===void 0&&(d=!0),d||delete i[e.field],l.createVNode(M.runtimeDoms.Item,null,{default(){return l.withDirectives(l.createVNode(M.runtimeDoms.FormItem,{label:`${e.label}:`,rules:e.rules,field:o},{default:()=>[l.createVNode(s,l.mergeProps({modelValue:i[e.field],"onUpdate:modelValue":w=>i[e.field]=w,placeholder:h},v),null)]}),[[l.vShow,d]])}})}runtimeGroupProcessor(e){let t;return l.createVNode(M.runtimeDoms.Group,{schema:e},b(t=e.children.map(i=>this.runtimeItemProcessor(i)))?t:{default:()=>[t]})}addListItem(e){var t,i;if(!((t=this.processors.rawModel[e.field])!=null&&t[0]))return Promise.reject({code:"0001",message:"异步默认值数据正在处理中，请您耐心等待... "});(i=this.processors.rawModel[e.field])!=null&&i[0]&&this.model.value[e.field].push(V(this.processors.rawModel[e.field][0]))}deleteListItem(e,t){this.model.value[e.field].splice(t,1)}runtimeListProcessor(e){const t=this;return l.createVNode(M.runtimeDoms.List,{schema:e},{default(){return t.model.value[e.field].map((i,f)=>l.createVNode(M.runtimeDoms.ListItem,null,{default(){return e.children.map((o,s)=>t.runtimeItemProcessor(o,s,i,e))},delete({container:o}={}){var c;let s=o??l.createVNode("button",null,null);return l.withDirectives(l.createVNode(s,{onClick:()=>t.deleteListItem(e,f)},null),[[l.vShow,((c=t.model.value[e.field])==null?void 0:c.length)>1]])}}))},add({container:i}={}){let f=i??l.createVNode("button",null,[l.createTextVNode("添加")]);return l.createVNode(f,{onClick:()=>t.addListItem(e)},null)}})}runtimeProcessor(e){return e.map(t=>(t.type||(t.type="item"),this.processorBySchemaType[t.type](t)))}exec(){let e;return l.createVNode(M.runtimeDoms.Form,{ref:this.formRef,model:this.model.value},b(e=this.runtimeProcessor(this.schemas.value))?e:{default:()=>[e]})}}class M{}a(M,"runtimeDoms");class S{constructor(){a(this,"effects",new Set)}clearEffects(){this.effects.clear()}triggerEffects(){Array.from(this.effects).forEach(e=>e())}trackEffect(e){this.effects.add(e)}}const F=class F{static getPlaceholderPrefixPresetByComponentName(){const e={请选择:["Select","Tree","TreeSelect"],请输入:["Input"]},t={};for(let i in e)e[i].forEach(f=>{t[f]=i});return t}};a(F,"schemaPreset",{type:{defaultValueWhenAsync:"item"},component:{defaultValueWhenAsync:void 0},componentProps:{defaultValueWhenAsync:void 0},defaultValue:{defaultValueWhenAsync:void 0},label:{defaultValueWhenAsync:""},field:{defaultValueWhenAsync:"__yiwwhl_async_field_fallback"},rules:{defaultValueWhenAsync:[]},show:{defaultValueWhenAsync:!0},required:{defaultValueWhenAsync:!1},placeholder:{defaultValueWhenAsync:void 0}}),a(F,"componentPropsPreset",{options:{defaultValueWhenAsync:[]}}),a(F,"placeholderPresetByComponentName",F.getPlaceholderPrefixPresetByComponentName());let A=F;const j=l.defineComponent({props:{setup:{type:Function,required:!0}},setup(u){const e=new D(u.setup);return()=>e.exec()}});function L(u){const e=new R(u);return[e.setup.bind(e),{submit:e.submit.bind(e)}]}function z(u){return{install(){M.runtimeDoms=u}}}exports.ProForm=j;exports.useForm=L;exports.useFormRenderer=z;
